<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Cluster Maintenance Operations · LogDevice</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Bootstrapping the cluster"/><meta name="docsearch:version" content="next"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Cluster Maintenance Operations · LogDevice"/><meta property="og:type" content="website"/><meta property="og:url" content="https://logdevice.io/index.html"/><meta property="og:description" content="## Bootstrapping the cluster"/><meta property="og:image" content="https://logdevice.io/img/logdevice_og.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://logdevice.io/img/logdevice.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://logdevice.io/blog/atom.xml" title="LogDevice Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://logdevice.io/blog/feed.xml" title="LogDevice Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-137238014-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/facebook_logdevice_whitewordmark.png" alt="LogDevice"/></a><a href="/versions.html"><h3>next</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/next/Overview.html" target="_self">Docs</a></li><li class=""><a href="/api/annotated.html" target="_self">API</a></li><li class=""><a href="/help.html" target="_self">Support</a></li><li class=""><a href="https://github.com/facebookincubator/LogDevice" target="_self">GitHub</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Administration</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Getting started<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/next/Overview.html">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/next/LocalCluster.html">Quickstart</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Concepts.html">Architecture</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Installation.html">Build LogDevice</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Configuration<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/next/FirstCluster.html">Creating your first cluster</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Config.html">Cluster configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Settings.html">Settings</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Logs.html">Log configuration</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Administration<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/next/administration/AdminServer.html">Admin Server (Control Plane)</a></li><li class="navListItem"><a class="navItem" href="/docs/next/administration/LDShell.html">LogDevice Shell</a></li><li class="navListItem"><a class="navItem" href="/docs/next/administration/LDQuery.html">LDQuery</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/next/administration/ClusterMaintenance.html">Cluster Maintenance</a></li><li class="navListItem"><a class="navItem" href="/docs/next/administration/SafetyChecker.html">Operations Safety Checker</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Concepts<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/next/Writepath.html">Write path</a></li><li class="navListItem"><a class="navItem" href="/docs/next/ReadPath.html">Read path</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Terminology.html">Terminology</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Consensus.html">Distributed consensus</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Designs<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/next/FailureDetection.html">Failure detection</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Replication.html">Log replication configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Recovery.html">Recovery after the failure of a sequencer</a></li><li class="navListItem"><a class="navItem" href="/docs/next/TrafficShaping.html">Traffic shaping</a></li><li class="navListItem"><a class="navItem" href="/docs/next/Rebuilding.html">Rebuilding</a></li><li class="navListItem"><a class="navItem" href="/docs/next/LogsDB.html">LogsDB</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">API<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/next/API_Introduction.html">Client library API</a></li><li class="navListItem"><a class="navItem" href="/docs/next/API_Doxygen.html">Reference</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Extending LogDevice<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/next/WritingPlugins.html">Writing plugins</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Cluster Maintenance Operations</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="bootstrapping-the-cluster"></a><a href="#bootstrapping-the-cluster" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bootstrapping the cluster</h2>
<p>This is an important first step to do once you create a cluster. Once you start
the minimum number of nodes that you require to operate a cluster based on your
configuration. You will need to run this command:</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-1-tab-2" class="nav-link active" data-group="group_1" data-tab="tab-group-1-content-2">CLI</div><div id="tab-group-1-tab-3" class="nav-link" data-group="group_1" data-tab="tab-group-1-content-3">Interactive</div></div><div class="tab-content"><div id="tab-group-1-content-2" class="tab-pane active" data-group="group_1" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">ldshell -s &lt;admin-server-host&gt; nodes-<span class="hljs-built_in">config</span> <span class="hljs-keyword">bootstrap </span>--metadata-replicate-across=<span class="hljs-string">"node:3"</span><br /></code></pre>
</span></div></div><div id="tab-group-1-content-3" class="tab-pane" data-group="group_1" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">root@logdevice&gt; nodes-config bootstrap <span class="hljs-attr">metadata-replicate-across=</span>{<span class="hljs-keyword">node</span><span class="hljs-title">:3</span>}<br /></code></pre>
</span></div></div></div></div>
This will allow the nodes to finish provisioning (finish transitioning to
`ENABLED`) and will tell maintenance manager about your required metadata
replication.
<blockquote>
<p>Note that metadata logs replication property cannot be changed later. This is
a critical decision that you need to carefully think about. A <code>node:3</code>
metadata replication on a 3-node cluster means that you cannot lose <strong>any</strong>
nodes, ever!</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="cluster-status"></a><a href="#cluster-status" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cluster Status</h2>
<p>You can use <a href="/docs/next/administration/LDShell.html">ldshell</a> to get the cluster status via the <code>status</code>
command.</p>
<pre><code class="hljs css language-shell-session">ldshell -s &lt;<span class="hljs-keyword">admin</span>-<span class="hljs-keyword">server</span>-host&gt; status
</code></pre>
<p><img src="/docs/assets/ldshell-status-1.png" alt="LDShell Screenshot" title="LDShell status example"></p>
<p>The status command will show the current and target states for the operational
state of shards and sequencers. This is especially useful if you want to know if
we have active maintenances and what are their status.</p>
<p><img src="/docs/assets/ldshell-status-2.png" alt="LDShell Screenshot" title="LDShell status example"></p>
<p>As you can see under the <code>SHARD OP.</code> (Shard Operational State) our current state
is <code>ENABLED(1)</code> which means that we have 1 shard in <code>ENABLED</code> state and we have
a target to become <code>MAY_DISAPPEAR(1)</code> for the same shard but we are
<code>BLOCKED_UNTIL_SAFE</code>.</p>
<p>If we run the command <code>maintenance show</code> in ldshell, we will be able to see the
reason.</p>
<p><img src="/docs/assets/ldshell-maintenance-capacity-1.png" alt="LDShell Screenshot" title="LDShell maintenance example"></p>
<p>Oh, our maintenance is blocked because we will cause <code>SEQUENCING_CAPACITY_LOSS</code>
and <code>STORAGE_CAPACITY_LOSS</code>. Check out <a href="/docs/next/administration/SafetyChecker.html">Safety Checker</a> to
figure out how to configure the cluster to allow more capacity loss.</p>
<blockquote>
<p>Hint: By default, we cannot lose more than 25% of the capacity unless we
configure the cluster to allow more. Since this is a 3-node cluster, losing a
single node means losing ~33.3% of the capacity which is not allowed.</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="expanding-the-cluster"></a><a href="#expanding-the-cluster" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Expanding the cluster</h2>
<p>Expanding a logdevice cluster is as simple as running more <code>logdeviced</code>
instances, nodes will automatically register themselves into the cluster and
<a href="/docs/next/administration/AdminServer.html#the-maintenance-manager">Maintenance Manager</a> will make sure
that these nodes are <code>ENABLED</code> once they become alive.</p>
<p>Check out an <a href="/docs/next/Config.html#nodes-nodes">example <code>logdeviced</code> invocation with
self-registration</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="applying-maintenances"></a><a href="#applying-maintenances" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Applying maintenances</h2>
<blockquote>
<p>Make sure that you carefully read the <a href="/docs/next/administration/AdminServer.html#the-maintenance-manager">Maintenance
Manager</a> for detailed explanation on
what the different states and arguments mean.</p>
</blockquote>
<h3><a class="anchor" aria-hidden="true" id="applying-an-unsafe-may_disappear-maintenance-on-a-single-node"></a><a href="#applying-an-unsafe-may_disappear-maintenance-on-a-single-node" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Applying an unsafe MAY_DISAPPEAR maintenance on a single node</h3>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-4-tab-5" class="nav-link active" data-group="group_4" data-tab="tab-group-4-content-5">CLI</div><div id="tab-group-4-tab-6" class="nav-link" data-group="group_4" data-tab="tab-group-4-content-6">Interactive</div></div><div class="tab-content"><div id="tab-group-4-content-5" class="tab-pane active" data-group="group_4" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">ldshell -s <span class="hljs-tag">&lt;admin-server-host&gt;</span> maintenance apply --<span class="hljs-keyword">node</span><span class="hljs-title">-indexes</span>=<span class="hljs-number">1</span><br />--<span class="hljs-attr">reason=</span><span class="hljs-string">"Testing MM"</span><br /></code></pre>
</span></div></div><div id="tab-group-4-content-6" class="tab-pane" data-group="group_4" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">root@logdevice&gt; maintenance apply <span class="hljs-keyword">node</span><span class="hljs-title">-indexes</span>=<span class="hljs-number">1</span> <span class="hljs-attr">reason=</span><span class="hljs-string">"Testing MM"</span><br /></code></pre>
</span></div></div></div></div>
<blockquote>
<p>Note: In this example cluster we configured the
<code>max-unavailable-storage-capacity</code> and <code>max-unavailable-sequencing-capacity</code>
to <code>50</code> to allow losing half the cluster so that capacity checking doesn't get
in our way.</p>
</blockquote>
<p>The output in our example case (assuming our k8s sample cluster):
<img src="/docs/assets/ldshell-maintenance-rebuilding-stall-1.png" alt="LDShell Screenshot" title="LDShell maintenance example">
As we can see, the <code>Impact Result: REBUILDING_STALL</code>.
Now, why is that happening? You probably assumed that by default it's safe to
take one node down in a 3-node cluster, right? This is why we need <a href="/docs/next/administration/AdminServer.html#the-maintenance-manager">Maintenance
Manager</a>. Checkout <a href="/docs/next/administration/SafetyChecker.html#why-do-we-need-a-safety-checker">Why do we need a
safety checker</a> to learn
more.</p>
<p>Luckily, there is a way to understand why. Let's run this command:</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-7-tab-8" class="nav-link active" data-group="group_7" data-tab="tab-group-7-content-8">CLI</div><div id="tab-group-7-tab-9" class="nav-link" data-group="group_7" data-tab="tab-group-7-content-9">Interactive</div></div><div class="tab-content"><div id="tab-group-7-content-8" class="tab-pane active" data-group="group_7" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">ldshell -s &lt;<span class="hljs-keyword">admin</span>-<span class="hljs-keyword">server</span>-host&gt; maintenance <span class="hljs-keyword">show</span> <span class="hljs-comment">--show-safety-check-results</span><br /><span class="hljs-comment">--reason="Testing MM"</span><br /></code></pre>
</span></div></div><div id="tab-group-7-content-9" class="tab-pane" data-group="group_7" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">root@logdevice&gt; maintenance <span class="hljs-keyword">show</span> <span class="hljs-keyword">show</span>-safety-<span class="hljs-keyword">check</span>-results=<span class="hljs-keyword">True</span><br /></code></pre>
</span></div></div></div></div>
Here is a snippet of the output
<pre><code class="hljs css language-text">Safety Check Impact:

CRITICAL: Internal Logs are affected negatively!

Log: 4611686018427387898 (maintenance_log_snapshots)
Epoch: 1
Storage-set Size: 3
Replication: {node: 3}
Write/Rebuilding availability: 3 → 2  (we need at least 3 nodes that are healthy, writable, and alive.)
Read availability: We can't afford losing more than . Nodes must be healthy, readable, and alive.
Impact: REBUILDING_STALL
+------------------------+--------------------------------------+------------------------+
| global.uk.k8s.nw.rk1.0 | global.uk.k8s.nw.rk1.1               | global.uk.k8s.nw.rk1.2 |
+------------------------+--------------------------------------+------------------------+
| N0:S0    READ_WRITE    | N1:S0    READ_WRITE → MAY_DISAPPEAR  | N2:S0    READ_WRITE    |
+------------------------+--------------------------------------+------------------------+
</code></pre>
<p>It turns out that the <a href="/docs/next/Config.html#internal-logs-internal_logs">internal logs</a>
are configured with <code>Replication: {node: 3}</code> which means that we cannot
rebuild historical data if we don't have 3 writeable nodes in that nodeset.
Since the entire cluster is 3 nodes we can't really stop any node or we won't
be able to re-replicate the under-replicated data!</p>
<p>We can update the configuration file to <code>&quot;node&quot;: 2</code> instead but this will not
fix the historical data. We will have to wait for automatic snapshotting and
trimming of internal logs before our maintenance is good to go.</p>
<h3><a class="anchor" aria-hidden="true" id="applying-an-may_disappear-maintenance-on-a-single-node"></a><a href="#applying-an-may_disappear-maintenance-on-a-single-node" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Applying an MAY_DISAPPEAR maintenance on a single node</h3>
<p>Assuming the scenario where our cluster is correctly configured to allow
losing 1 node.</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-10-tab-11" class="nav-link active" data-group="group_10" data-tab="tab-group-10-content-11">CLI</div><div id="tab-group-10-tab-12" class="nav-link" data-group="group_10" data-tab="tab-group-10-content-12">Interactive</div></div><div class="tab-content"><div id="tab-group-10-content-11" class="tab-pane active" data-group="group_10" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">ldshell -s <span class="hljs-tag">&lt;admin-server-host&gt;</span> maintenance apply --<span class="hljs-keyword">node</span><span class="hljs-title">-indexes</span>=<span class="hljs-number">3</span><br />--<span class="hljs-attr">reason=</span><span class="hljs-string">"will restart"</span><br /></code></pre>
</span></div></div><div id="tab-group-10-content-12" class="tab-pane" data-group="group_10" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">root@logdevice&gt; maintenance apply <span class="hljs-keyword">node</span><span class="hljs-title">-indexes</span>=<span class="hljs-number">3</span> <span class="hljs-attr">reason=</span><span class="hljs-string">"will restart"</span><br /></code></pre>
</span></div></div></div></div>
<p><img src="/docs/assets/ldshell-maintenance-safe-1.png" alt="LDShell Screenshot" title="LDShell maintenance example"></p>
<p>After a couple of minutes, if we run the <em>exact same command</em> again, or if we
used <code>maintenance show</code>. We should see the maintenance status similar to this:</p>
<p><img src="/docs/assets/ldshell-maintenance-completed-1.png" alt="LDShell Screenshot" title="LDShell maintenance example"></p>
<p>And in <code>ldshell status</code> we will see the current state of the sequencer to be
<code>DISABLED</code> and the shard operational state is set to <code>MAY_DISAPPEAR</code>.</p>
<p><img src="/docs/assets/ldshell-status-completed-maintenance-1.png" alt="LDShell Screenshot" title="LDShell maintenance example">
Only now we can safely restart this node!</p>
<h3><a class="anchor" aria-hidden="true" id="removing-a-maintenance"></a><a href="#removing-a-maintenance" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Removing a maintenance</h3>
<p>We can easily remove a maintenance by using the <code>maintenance remove</code> which can
remove multiple maintenance at the same time if you didn't supply filters to it.</p>
<p>For our maintenance, this is how we will remove it:</p>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-13-tab-14" class="nav-link active" data-group="group_13" data-tab="tab-group-13-content-14">CLI</div><div id="tab-group-13-tab-15" class="nav-link" data-group="group_13" data-tab="tab-group-13-content-15">Interactive</div></div><div class="tab-content"><div id="tab-group-13-content-14" class="tab-pane active" data-group="group_13" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">ldshell -s &lt;admin-server-host&gt; maintenance <span class="hljs-builtin-name">remove</span> <span class="hljs-attribute">--node-indexes</span>=3<br /><span class="hljs-attribute">--reason</span>=<span class="hljs-string">"restart completed"</span><br /></code></pre>
</span></div></div><div id="tab-group-13-content-15" class="tab-pane" data-group="group_13" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">root@logdevice&gt; maintenance <span class="hljs-builtin-name">remove</span> <span class="hljs-attribute">node-indexes</span>=3 <span class="hljs-attribute">reason</span>=<span class="hljs-string">"restart completed"</span><br /></code></pre>
</span></div></div></div></div>
After confirmation, the maintenance will be removed and the node will go back to
`ENABLED` after a couple of seconds.
<h3><a class="anchor" aria-hidden="true" id="draining-a-couple-of-nodes"></a><a href="#draining-a-couple-of-nodes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Draining a couple of nodes</h3>
<div class="tabs"><div class="nav-tabs"><div id="tab-group-16-tab-17" class="nav-link active" data-group="group_16" data-tab="tab-group-16-content-17">CLI</div><div id="tab-group-16-tab-18" class="nav-link" data-group="group_16" data-tab="tab-group-16-content-18">Interactive</div></div><div class="tab-content"><div id="tab-group-16-content-17" class="tab-pane active" data-group="group_16" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">ldshell -s &lt;<span class="hljs-keyword">admin</span>-<span class="hljs-keyword">server</span>-host&gt; maintenance apply \<br />         <span class="hljs-comment">--node-indexes 3 4 \</span><br />         <span class="hljs-comment">--shard-target-state=drained \</span><br />         <span class="hljs-comment">--reason "will shrink"</span><br /></code></pre>
</span></div></div><div id="tab-group-16-content-18" class="tab-pane" data-group="group_16" tabindex="-1"><div><span><pre><code class="hljs css language-shell-session">root@logdevice&gt; maintenance apply <span class="hljs-keyword">node</span><span class="hljs-title">-indexes</span>=[<span class="hljs-number">3</span>, <span class="hljs-number">4</span>] <span class="hljs-attr">shard-target-state=</span>drained <span class="hljs-attr">reason=</span><span class="hljs-string">"will shrink"</span><br /></code></pre>
</span></div></div></div></div>
<p><img src="/docs/assets/ldshell-maintenance-drain-two-nodes-1.png" alt="LDShell Screenshot" title="LDShell maintenance example">
This will trigger data rebuilding, and the nodes will move into <code>MIGRATING_DATA</code>
and as shards finish you will see one by one the shards go to <code>DRAINED</code>. But the
maintenance <code>Overall Status</code> will transition to <code>COMPLETED</code> <strong>only</strong> when all
requested shards finish rebuilding and transition to <code>DRAINED</code>.</p>
<p><img src="/docs/assets/ldshell-maintenance-drain-two-nodes-2.png" alt="LDShell Screenshot" title="LDShell maintenance example"></p>
<h2><a class="anchor" aria-hidden="true" id="shrinking-the-cluster"></a><a href="#shrinking-the-cluster" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Shrinking the cluster</h2>
<p>In order to shrink the cluster, you need first to apply <code>DRAINED</code> maintenances
on the storage nodes that you want to remove along with disabling any sequencers
running on these nodes. See <a href="#applying-maintenances">Applying maintenances</a> for
reference.</p>
<blockquote>
<p>Note that draining the nodes might take quite sometime since we need to
finish data rebuilding before setting the state to <code>DRAINED</code>.</p>
</blockquote>
<p>Once these maintenances are <code>COMPLETED</code>, we know that it's safe to remove the
nodes. The nodes <em>must</em> be stopped (by making sure that <code>logdeviced</code> is not
running on these nodes). Only then, you can run the shrink command:</p>
<p>This assumes that the node ID for the node you want to remove is <code>5</code></p>
<pre><code class="hljs css language-shell-session">ldshell -s <span class="hljs-tag">&lt;admin-server-host&gt;</span> nodes-config shrink --<span class="hljs-keyword">node</span><span class="hljs-title">-indexes</span>=<span class="hljs-number">5</span>
Successfully removed the nodes
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/next/administration/LDQuery.html"><span class="arrow-prev">← </span><span>LDQuery</span></a><a class="docs-next button" href="/docs/next/administration/SafetyChecker.html"><span>Operations Safety Checker</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#bootstrapping-the-cluster">Bootstrapping the cluster</a></li><li><a href="#cluster-status">Cluster Status</a></li><li><a href="#expanding-the-cluster">Expanding the cluster</a></li><li><a href="#applying-maintenances">Applying maintenances</a><ul class="toc-headings"><li><a href="#applying-an-unsafe-may_disappear-maintenance-on-a-single-node">Applying an unsafe MAY_DISAPPEAR maintenance on a single node</a></li><li><a href="#applying-an-may_disappear-maintenance-on-a-single-node">Applying an MAY_DISAPPEAR maintenance on a single node</a></li><li><a href="#removing-a-maintenance">Removing a maintenance</a></li><li><a href="#draining-a-couple-of-nodes">Draining a couple of nodes</a></li></ul></li><li><a href="#shrinking-the-cluster">Shrinking the cluster</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logdevice.svg" alt="LogDevice" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/Overview.html">Getting Started</a><a href="/docs/FirstCluster.html">Creating your first cluster</a><a href="/api/annotated.html">C++ API Reference</a></div><div><h5>Community</h5><a href="https://facebook.com/groups/logdevice.oss/">LogDevice Users Group</a><a href="http://stackoverflow.com/questions/tagged/logdevice" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="/blog">Blog</a><a href="https://github.com/facebookincubator/LogDevice">GitHub</a></div></section><a href="https://code.facebook.com/projects/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2019 Facebook</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f0ece773627cb7003a57c0edd6ec7dd8',
                indexName: 'logdevice',
                inputSelector: '#search_input_react'
              });
            </script></body></html>